<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>QualiText - Análisis de Datos Cualitativos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.0.1/dist/chartjs-chart-matrix.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>
  <script src="https://unpkg.com/d3-cloud/build/d3.layout.cloud.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style id="app-style">
    .file-item.selected {
      background-color: #e0e7ff;
      border: 1px solid #6366F1
    }
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    
    .word-cloud-container {
      height: 400px;
      position: relative;
    }

    .drag-area {
      border: 2px dashed #4F46E5;
      height: 200px;
      transition: all 0.3s ease;
    }
    
    .drag-area.active {
      border-color: #818CF8;
      background-color: rgba(79, 70, 229, 0.1);
    }
    
    .loading-overlay {
      background-color: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(6px);
      z-index: 50;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    
    .spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      border-left-color: #4F46E5;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }
      100% {
        transform: rotate(360deg);
      }
    }
    
    .file-item {
      transition: all 0.2s ease-in-out;
    }
    
    .file-item:hover {
      background-color: rgba(79, 70, 229, 0.05);
    }
    
    .pattern-item {
      transition: transform 0.2s ease;
    }
    
    .pattern-item:hover {
      transform: translateY(-2px);
    }

    .tooltip {
      position: absolute;
      padding: 8px 12px;
      background: rgba(0, 0, 0, 0.8);
      color: white;
      border-radius: 4px;
      pointer-events: none;
      font-size: 12px;
      z-index: 10;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .wave-bg {
      width: 100%;
      height: 100%;
      position: absolute;
      background: linear-gradient(60deg, rgba(84, 58, 183, 0.1) 0%, rgba(0, 172, 193, 0.1) 100%);
      left: 0;
      top: 0;
      z-index: -1;
    }
    
    .wave-animation {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100px;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 120" preserveAspectRatio="none"><path d="M0,0V46.29c47.79,22.2,103.59,32.17,158,28,70.36-5.37,136.33-33.31,206.8-37.5C438.64,32.43,512.34,53.67,583,72.05c69.27,18,138.3,24.88,209.4,13.08,36.15-6,69.85-17.84,104.45-29.34C989.49,25,1113-14.29,1200,52.47V0Z" opacity=".25" fill="%234F46E5" /><path d="M0,0V15.81C13,36.92,27.64,56.86,47.69,72.05,99.41,111.27,165,111,224.58,91.58c31.15-10.15,60.09-26.07,89.67-39.8,40.92-19,84.73-46,130.83-49.67,36.26-2.85,70.9,9.42,98.6,31.56,31.77,25.39,62.32,62,103.63,73,40.44,10.79,81.35-6.69,119.13-24.28s75.16-39,116.92-43.05c59.73-5.85,113.28,22.88,168.9,38.84,30.2,8.66,59,6.17,87.09-7.5,22.43-10.89,48-26.93,60.65-49.24V0Z" opacity=".5" fill="%234F46E5" /><path d="M0,0V5.63C149.93,59,314.09,71.32,475.83,42.57c43-7.64,84.23-20.12,127.61-26.46,59-8.63,112.48,12.24,165.56,35.4C827.93,77.22,886,95.24,951.2,90c86.53-7,172.46-45.71,248.8-84.81V0Z" fill="%234F46E5" /></svg>');
      background-size: 1200px 100px;
      animation: wave 10s linear infinite;
    }
    
    @keyframes wave {
      0% {
        transform: translateX(0);
      }
      50% {
        transform: translateX(-25%);
      }
      100% {
        transform: translateX(-50%);
      }
    }

    .tab-button {
      transition: all 0.3s ease;
      color: #6B7280;
      border-bottom: 2px solid transparent;
    }
    
    .tab-button.active {
      color: #4F46E5;
      border-bottom: 2px solid #4F46E5;
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }

    [contenteditable="true"] {
        min-height: 50px;
        border: 1px solid #E5E7EB;
        border-radius: 0.375rem;
        padding: 0.75rem;
        outline: none;
        transition: border-color 0.2s ease-in-out;
    }

    [contenteditable="true"]:focus {
        border-color: #6366F1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
    }

    .percent-bar {
      background: linear-gradient(90deg, rgba(79, 70, 229, 0.6) 0%, rgba(99, 102, 241, 0.4) 100%);
      height: 18px;
      border-radius: 4px;
      position: relative;
    }

    .percent-value {
      position: absolute;
      right: 6px;
      font-size: 11px;
      line-height: 18px;
      font-weight: 500;
      color: #4F46E5;
    }

    .chart-legend {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 8px;
    }

    .chart-legend-item {
      display: flex;
      align-items: center;
      font-size: 12px;
    }

    .chart-legend-color {
      width: 12px;
      height: 12px;
      margin-right: 4px;
      border-radius: 2px;
    }
  </style>
</head>
<body class="bg-gray-50">
  <header class="bg-white shadow-sm">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <div class="flex items-center">
        <i class="fas fa-chart-pie text-indigo-600 text-2xl mr-2"></i>
        <h1 class="text-xl font-bold text-gray-900">QualiText</h1>
        <span class="ml-2 text-sm text-gray-600">Análisis de Datos Cualitativos</span>
      </div>
      <div>
        <button id="helpBtn" class="text-gray-600 hover:text-indigo-600 px-3 py-2 rounded-md text-sm font-medium flex items-center">
          <i class="fas fa-question-circle mr-1"></i>
          Ayuda
        </button>
      </div>
    </div>
  </header>

  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <section id="uploadSection" class="mb-12">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Cargar datos para analizar</h2>
      <div class="drag-area rounded-lg flex flex-col items-center justify-center cursor-pointer bg-white p-6">
        <i class="fas fa-cloud-upload-alt text-4xl text-indigo-600 mb-4"></i>
        <h3 class="text-lg font-medium text-gray-700 mb-2">Arrastra y suelta archivos o</h3>
        <label for="fileInput" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md cursor-pointer transition-colors duration-200">
          Seleccionar archivos
        </label>
        <input type="file" id="fileInput" class="hidden" multiple accept=".csv,.xlsx,.txt">
        <p class="mt-2 text-sm text-gray-500">Formatos soportados: CSV, Excel, TXT</p>
      </div>
      
      <div id="fileList" class="mt-8 bg-white rounded-lg shadow p-4 hidden">
        <h3 class="text-lg font-semibold text-gray-800 mb-4">Archivos cargados</h3>
        <div id="fileItemsContainer" class="space-y-3"></div>
      </div>
      
      <div class="mt-8 text-center">
        <button id="analyzeBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-8 rounded-md disabled:opacity-50 disabled:cursor-not-allowed text-center inline-flex items-center justify-center transition-colors duration-200" disabled>
          <i class="fas fa-chart-bar mr-2"></i>
          Analizar datos
        </button>
      </div>
    </section>
    
    <section id="resultsSection" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold text-gray-800">Resultados del análisis</h2>
        <div class="space-x-3">
          <button id="exportBtn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md inline-flex items-center transition-colors duration-200">
            <i class="fas fa-download mr-2"></i>
            Exportar ZIP
          </button>
          <button id="exportExcelBtn" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md inline-flex items-center transition-colors duration-200">
            <i class="fas fa-file-excel mr-2"></i>
            Exportar Excel
          </button>
          <button id="resetBtn" class="bg-gray-500 hover:bg-gray-600 text-white py-2 px-4 rounded-md inline-flex items-center transition-colors duration-200">
            <i class="fas fa-redo-alt mr-2"></i>
            Reiniciar
          </button>
        </div>
      </div>
      
      <div class="border-b border-gray-200 mb-6">
        <nav class="flex space-x-8">
          <button data-tab="visualizationTab" class="tab-button active py-4 px-1 border-b-2 font-medium text-sm">
            <i class="fas fa-chart-pie mr-2"></i>
            Visualización
          </button>
          <button data-tab="patternsTab" class="tab-button py-4 px-1 border-b-2 font-medium text-sm">
            <i class="fas fa-sitemap mr-2"></i>
            Patrones y Temas
          </button>
          <button data-tab="termsTab" class="tab-button py-4 px-1 border-b-2 font-medium text-sm">
            <i class="fas fa-font mr-2"></i>
            Términos Clave
          </button>
          <button data-tab="analysisTab" class="tab-button py-4 px-1 border-b-2 font-medium text-sm">
            <i class="fas fa-brain mr-2"></i>
            Análisis Interpretativo
          </button>
        </nav>
      </div>
      
      <div id="visualizationTab" class="tab-content active">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="bg-white p-6 rounded-lg shadow">
            <div class="flex justify-between items-center mb-4">
              <h3 class="text-lg font-semibold text-gray-800">Frecuencia de términos</h3>
              <div class="flex space-x-2">
                <div>
                  <label for="topTermsCount" class="block text-xs text-gray-600 mb-1">Mostrar términos</label>
                  <select id="topTermsCount" class="form-select rounded-md border-gray-300 shadow-sm text-sm">
                    <option value="5">Top 5</option>
                    <option value="10" selected>Top 10</option>
                    <option value="15">Top 15</option>
                    <option value="20">Top 20</option>
                  </select>
                </div>
                <div>
                  <label for="freqThreshold" class="block text-xs text-gray-600 mb-1">Frecuencia mínima</label>
                  <input type="number" id="freqThreshold" min="1" value="2" class="form-input rounded-md border-gray-300 shadow-sm text-sm w-16">
                </div>
              </div>
            </div>
            <div class="h-80">
              <canvas id="termsChart"></canvas>
            </div>
          </div>
          
          <div class="bg-white p-6 rounded-lg shadow">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Nube de palabras</h3>
            <div id="wordCloud" class="word-cloud-container"></div>
            <div class="tooltip" id="wordcloudTooltip"></div>
          </div>
        </div>
      </div>
      
      <div id="patternsTab" class="tab-content">
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Patrones recurrentes y temas emergentes</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
              <h4 class="font-medium text-gray-700 mb-3">Temas principales</h4>
              <div id="themesContainer" class="space-y-4">
                <div class="pattern-item bg-white p-4 border border-gray-200 rounded-md">
                  <h5 class="font-medium text-gray-800">Diversidad e inclusión</h5>
                  <p class="text-sm text-gray-600 mt-1 mb-2">Comentarios sobre políticas de inclusión y representación diversa</p>
                  <div class="mt-2">
                    <span class="text-xs font-medium text-gray-500 block mb-1">Términos relacionados:</span>
                    <div class="flex flex-wrap gap-1">
                      <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full">diversidad</span>
                      <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full">inclusión</span>
                      <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full">representación</span>
                    </div>
                  </div>
                </div>
                <div class="pattern-item bg-white p-4 border border-gray-200 rounded-md">
                  <h5 class="font-medium text-gray-800">Equidad y liderazgo</h5>
                  <p class="text-sm text-gray-600 mt-1 mb-2">Percepciones sobre equidad y oportunidades de liderazgo</p>
                  <div class="mt-2">
                    <span class="text-xs font-medium text-gray-500 block mb-1">Términos relacionados:</span>
                    <div class="flex flex-wrap gap-1">
                      <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full">equidad</span>
                      <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full">liderazgo</span>
                      <span class="bg-indigo-100 text-indigo-700 text-xs px-2 py-1 rounded-full">oportunidades</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div>
              <h4 class="font-medium text-gray-700 mb-3">Patrones de respuesta</h4>
              <div id="patternsContainer" class="space-y-3">
                <div class="pattern-item bg-white p-4 border border-gray-200 rounded-md">
                  <h5 class="font-medium text-gray-800">Necesidad de mayor formación</h5>
                  <div class="flex items-center mt-1">
                    <span class="text-sm text-gray-500">Frecuencia:</span>
                    <span class="ml-1 text-sm font-medium text-gray-700">18</span>
                  </div>
                  <div class="mt-2">
                    <span class="text-xs font-medium text-gray-500 block mb-1">Ejemplos:</span>
                    <ul class="text-sm text-gray-600 pl-5 list-disc">
                      <li>Hace falta más capacitación sobre diversidad e inclusión</li>
                      <li>Se requieren talleres prácticos sobre equidad</li>
                      <li>La formación actual es insuficiente</li>
                    </ul>
                  </div>
                </div>
                <div class="pattern-item bg-white p-4 border border-gray-200 rounded-md">
                  <h5 class="font-medium text-gray-800">Problemas de comunicación</h5>
                  <div class="flex items-center mt-1">
                    <span class="text-sm text-gray-500">Frecuencia:</span>
                    <span class="ml-1 text-sm font-medium text-gray-700">12</span>
                  </div>
                  <div class="mt-2">
                    <span class="text-xs font-medium text-gray-500 block mb-1">Ejemplos:</span>
                    <ul class="text-sm text-gray-600 pl-5 list-disc">
                      <li>La comunicación entre departamentos es deficiente</li>
                      <li>No hay transparencia en las decisiones</li>
                      <li>Falta de claridad en los objetivos</li>
                    </ul>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="mt-8">
            <h4 class="font-medium text-gray-700 mb-3">Correlaciones entre temas</h4>
            <div class="h-64"><canvas id="correlationChart"></canvas></div>
            <p class="text-gray-500 text-sm mt-2">Este gráfico muestra la fuerza de relación entre los diferentes temas identificados</p>
          </div>
        </div>
      </div>
      
      <div id="termsTab" class="tab-content">
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Términos clave identificados</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
            <div class="bg-indigo-50 p-4 rounded-md">
              <p class="text-sm text-gray-600">Términos totales</p>
              <p class="text-2xl font-bold text-indigo-700">68</p>
            </div>
            <div class="bg-indigo-50 p-4 rounded-md">
              <p class="text-sm text-gray-600">Respuestas analizadas</p>
              <p class="text-2xl font-bold text-indigo-700">120</p>
            </div>
            <div class="bg-indigo-50 p-4 rounded-md">
              <p class="text-sm text-gray-600">Relevancia promedio</p>
              <p class="text-2xl font-bold text-indigo-700">78%</p>
            </div>
          </div>
          <div class="overflow-x-auto mt-4">
            <table class="min-w-full divide-y divide-gray-200">
              <thead>
                <tr class="bg-gray-100">
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Término</th>
                  <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Frecuencia</th>
                  <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">% del Total</th>
                  <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Relevancia</th>
                  <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ejemplos</th>
                </tr>
              </thead>
              <tbody id="termsTableBody" class="bg-white divide-y divide-gray-200">
                <tr class="bg-white">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">diversidad</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">42</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <div class="w-full bg-gray-200 rounded-full h-[18px] relative">
                      <div class="percent-bar" style="width: 35%">
                        <span class="percent-value">35%</span>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">85</td>
                  <td class="px-6 py-4 text-sm text-gray-500">
                    <p class="mb-1">"La diversidad en el equipo ha mejorado notablemente este año"</p>
                    <p class="mb-1">"Necesitamos más diversidad en puestos de liderazgo"</p>
                  </td>
                </tr>
                <tr class="bg-gray-50">
                  <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">inclusión</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">38</td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <div class="w-full bg-gray-200 rounded-full h-[18px] relative">
                      <div class="percent-bar" style="width: 31.6%">
                        <span class="percent-value">31.6%</span>
                      </div>
                    </div>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-center">82</td>
                  <td class="px-6 py-4 text-sm text-gray-500">
                    <p class="mb-1">"Las políticas de inclusión han sido bien recibidas"</p>
                    <p class="mb-1">"Falta una verdadera cultura de inclusión"</p>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      
      <div id="analysisTab" class="tab-content">
        <div class="bg-white p-6 rounded-lg shadow">
          <h3 class="text-lg font-semibold text-gray-800 mb-4">Análisis interpretativo</h3>
          <div class="mb-6">
            <h4 class="font-medium text-gray-700 mb-2">Resumen ejecutivo</h4>
            <div id="executiveSummary" class="text-gray-600" contenteditable="true">
              El análisis de las respuestas muestra una preocupación generalizada por la diversidad e inclusión en el entorno laboral. Los participantes reconocen avances significativos en políticas institucionales, pero señalan brechas importantes en su implementación práctica y en la representación en posiciones de liderazgo. La formación y comunicación emergen como áreas críticas de mejora.
            </div>
          </div>
          <div class="mb-6">
            <h4 class="font-medium text-gray-700 mb-2">Hallazgos principales</h4>
            <div id="mainFindings" class="space-y-4 text-gray-600" contenteditable="true">
              <p>Las respuestas muestran una tendencia positiva en la percepción de las políticas de diversidad, con un 68% de menciones favorables.</p>
              <p>Existe una brecha significativa entre el reconocimiento de políticas (82%) y su implementación efectiva (43%).</p>
              <p>Los comentarios sobre formación y capacitación representan el tercer tema más mencionado, sugiriendo una necesidad no cubierta.</p>
            </div>
          </div>
          <div class="mb-6">
            <h4 class="font-medium text-gray-700 mb-2">Análisis detallado</h4>
            <div id="detailedAnalysis" class="prose max-w-none text-gray-600" contenteditable="true">
              El análisis de las respuestas cualitativas revela patrones consistentes sobre la percepción de diversidad e inclusión en la organización. Los términos más frecuentes ("diversidad", "inclusión", "equidad") aparecen en contextos tanto positivos como críticos, lo que indica una valoración matizada de las iniciativas organizacionales.
              
              Las referencias a "liderazgo" suelen estar vinculadas a preocupaciones sobre representación diversa en puestos directivos, mientras que las menciones de "comunicación" tienden a enfocarse en la transparencia de políticas y decisiones.
              
              El análisis de co-ocurrencia muestra una fuerte asociación entre "capacitación" y "necesidad", sugiriendo que las iniciativas formativas actuales no satisfacen completamente las expectativas del personal.
              
              La intensidad emocional es más alta en comentarios relacionados con "oportunidades" y "promoción", indicando que las percepciones de equidad en el desarrollo profesional generan respuestas particularmente enfáticas.
            </div>
          </div>
          <div>
            <h4 class="font-medium text-gray-700 mb-2">Recomendaciones</h4>
            <div id="recommendations" class="space-y-3 text-gray-600" contenteditable="true">
              <p>Reforzar programas de capacitación específica sobre diversidad e inclusión, con énfasis en aplicaciones prácticas.</p>
              <p>Implementar medidas concretas para aumentar la transparencia en procesos de promoción y desarrollo profesional.</p>
              <p>Establecer canales de comunicación bidireccionales para monitorear la efectividad de las políticas implementadas.</p>
              <p>Desarrollar indicadores específicos para medir el progreso en diversidad e inclusión a nivel departamental.</p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <div id="columnSelectorModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg max-w-lg w-full p-6 mx-4 shadow-lg">
      <h3 class="text-xl font-bold text-gray-900 mb-4">Seleccionar columna de texto</h3>
      <p class="text-gray-700 mb-4">Hemos detectado archivos CSV o Excel. Por favor, selecciona la columna que contiene las respuestas cualitativas a analizar.</p>
      <div class="mb-4">
        <label for="columnSelect" class="block text-sm font-medium text-gray-700 mb-2">Columna:</label>
        <select id="columnSelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
        </select>
      </div>
      <div class="flex justify-end space-x-3">
        <button id="cancelColumnSelectionBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-md">Cancelar</button>
        <button id="confirmColumnSelectionBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-md">Confirmar</button>
      </div>
    </div>
  </div>

  <div id="loadingOverlay" class="fixed inset-0 loading-overlay hidden">
    <div class="wave-bg">
      <div class="wave-animation"></div>
    </div>
    <div class="spinner mb-4"></div>
    <p class="text-lg font-medium text-gray-800 mb-2">Analizando datos...</p>
    <p id="loadingMessage" class="text-sm text-gray-600">Iniciando el proceso...</p>
  </div>

  <div id="helpModal" class="fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg max-w-2xl w-full p-6 mx-4">
      <div class="flex justify-between items-start mb-4">
        <h3 class="text-xl font-bold text-gray-900">Acerca de QualiText</h3>
        <button id="closeHelpBtn" class="text-gray-400 hover:text-gray-500">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="space-y-4">
        <p>QualiText es una herramienta diseñada para analizar datos cualitativos de forma rápida y eficiente, facilitando la extracción de insights valiosos de respuestas abiertas.</p>
        
        <div>
          <h4 class="font-medium text-gray-800 mb-2">Cómo usar QualiText:</h4>
          <ol class="list-decimal pl-5 space-y-2 text-gray-600">
            <li>Carga tus archivos CSV, Excel o TXT con respuestas cualitativas.</li>
            <li>Selecciona la columna específica que contiene el texto a analizar (para CSV/Excel).</li>
            <li>Haz clic en "Analizar datos" y espera mientras procesamos tu información.</li>
            <li>Explora los resultados en las diferentes pestañas de visualización, patrones, términos y análisis.</li>
            <li>Exporta tus resultados en formato ZIP o Excel para compartirlos o trabajar con ellos offline.</li>
          </ol>
        </div>
        
        <div>
          <h4 class="font-medium text-gray-800 mb-2">Características principales:</h4>
          <ul class="list-disc pl-5 space-y-1 text-gray-600">
            <li>Análisis automatizado de textos en español</li>
            <li>Identificación de términos clave y su frecuencia</li>
            <li>Detección de patrones y temas emergentes</li>
            <li>Visualizaciones interactivas</li>
            <li>Análisis interpretativo editable</li>
            <li>Exportación de resultados en múltiples formatos</li>
          </ul>
        </div>
        
        <div class="bg-blue-50 p-4 rounded-md">
          <h4 class="font-medium text-blue-800 mb-1">Privacidad</h4>
          <p class="text-blue-700 text-sm">Tus datos permanecen en tu navegador y no se almacenan en servidores externos. Los análisis se realizan mediante una API segura y no conservamos copias de tus archivos originales.</p>
        </div>
      </div>
      <div class="mt-6 pt-4 border-t border-gray-200">
        <p class="text-sm text-gray-500 text-center">QualiText © 2025 - Versión 1.1</p>
      </div>
    </div>
  </div>

  <script id="app-script">
    const app = {
      files: [],
      analysisResults: null,
      chartInstances: {},
      chartConfig: { matrixAvailable: false },
      unsavedChanges: false
    };

    const elements = {
      uploadSection: document.getElementById('uploadSection'),
      resultsSection: document.getElementById('resultsSection'),
      dragArea: document.querySelector('.drag-area'),
      fileInput: document.getElementById('fileInput'),
      fileList: document.getElementById('fileList'),
      fileItemsContainer: document.getElementById('fileItemsContainer'),
      analyzeBtn: document.getElementById('analyzeBtn'),
      loadingOverlay: document.getElementById('loadingOverlay'),
      loadingMessage: document.getElementById('loadingMessage'),
      helpBtn: document.getElementById('helpBtn'),
      helpModal: document.getElementById('helpModal'),
      closeHelpBtn: document.getElementById('closeHelpBtn'),
      exportBtn: document.getElementById('exportBtn'),
      exportExcelBtn: document.getElementById('exportExcelBtn'),
      resetBtn: document.getElementById('resetBtn'),
      topTermsCount: document.getElementById('topTermsCount'),
      freqThreshold: document.getElementById('freqThreshold'),
      tabButtons: document.querySelectorAll('.tab-button'),
      tabContents: document.querySelectorAll('.tab-content'),
      columnSelectorModal: document.getElementById('columnSelectorModal'),
      columnSelect: document.getElementById('columnSelect'),
      confirmColumnSelectionBtn: document.getElementById('confirmColumnSelectionBtn'),
      cancelColumnSelectionBtn: document.getElementById('cancelColumnSelectionBtn'),
      executiveSummary: document.getElementById('executiveSummary'),
      mainFindings: document.getElementById('mainFindings'),
      detailedAnalysis: document.getElementById('detailedAnalysis'),
      recommendations: document.getElementById('recommendations'),
      termsTableBody: document.getElementById('termsTableBody'),
      themesContainer: document.getElementById('themesContainer'),
      patternsContainer: document.getElementById('patternsContainer')
    };

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function showLoading(message = 'Procesando...') {
      elements.loadingMessage.textContent = message;
      elements.loadingOverlay.classList.remove('hidden');
    }

    function hideLoading() {
      elements.loadingOverlay.classList.add('hidden');
    }

    function showToast(message, type = 'info') {
      // Simple implementation - replace with more sophisticated toast if needed
      alert(message);
    }

    function showColumnSelector(fileEntry, callback) {
      // Populate column selector dropdown
      elements.columnSelect.innerHTML = '';
      
      if (!fileEntry.parsedData || fileEntry.parsedData.length === 0) {
        showToast('No se encontraron datos para seleccionar columnas', 'error');
        return;
      }
      
      // Get columns from the first row
      const firstRow = fileEntry.parsedData[0];
      const columns = Object.keys(firstRow);
      
      columns.forEach(column => {
        const option = document.createElement('option');
        option.value = column;
        option.textContent = column;
        elements.columnSelect.appendChild(option);
      });
      
      // Show modal
      elements.columnSelectorModal.classList.remove('hidden');
      
      // Store current fileEntry
      elements.columnSelect.dataset.fileId = fileEntry.id;
      
      // Set callback if provided
      if (callback) {
        elements.confirmColumnSelectionBtn.dataset.hasCallback = 'true';
      } else {
        delete elements.confirmColumnSelectionBtn.dataset.hasCallback;
      }
      
      // Confirm handler
      elements.confirmColumnSelectionBtn.onclick = function() {
        const selectedColumn = elements.columnSelect.value;
        const fileId = elements.columnSelect.dataset.fileId;
        
        // Find the file entry and set text column
        const fileEntryToUpdate = app.files.find(f => f.id === fileId);
        if (fileEntryToUpdate) {
          fileEntryToUpdate.textColumn = selectedColumn;
          saveToLocalStorage();
          updateFileList();
          checkAnalyzeButtonState();
        }
        
        elements.columnSelectorModal.classList.add('hidden');
        
        // Call callback if exists
        if (callback && elements.confirmColumnSelectionBtn.dataset.hasCallback) {
          callback();
        }
      };
      
      // Cancel handler
      elements.cancelColumnSelectionBtn.onclick = function() {
        elements.columnSelectorModal.classList.add('hidden');
      };
    }

    function saveToLocalStorage() {
      try {
        // Create a simplified version of files to store (without the actual File objects)
        const filesToStore = app.files.map(f => ({
          id: f.id,
          name: f.file.name,
          size: f.file.size,
          type: f.file.type,
          textColumn: f.textColumn,
          parsedData: f.parsedData
        }));
        
        // Store files info and analysis results
        localStorage.setItem('qualitext_files', JSON.stringify(filesToStore));
        localStorage.setItem('qualitext_results', JSON.stringify(app.analysisResults));
        localStorage.setItem('qualitext_timestamp', Date.now());
        
        console.log("Estado guardado en localStorage");
      } catch (e) {
        console.error("Error guardando en localStorage:", e);
      }
    }

    async function loadFromLocalStorage() {
      try {
        const storedFiles = localStorage.getItem('qualitext_files');
        const storedResults = localStorage.getItem('qualitext_results');
        const timestamp = localStorage.getItem('qualitext_timestamp');
        
        if (!storedFiles || !timestamp) return false;
        
        // Check if stored data is recent (within last 24 hours)
        const now = Date.now();
        const isRecent = (now - parseInt(timestamp)) < 24 * 60 * 60 * 1000;
        
        if (!isRecent) {
          console.log("Datos almacenados antiguos, ignorando");
          return false;
        }
        
        // Load analysis results if available
        if (storedResults) {
          try {
            app.analysisResults = JSON.parse(storedResults);
            console.log("Resultados de análisis cargados");
          } catch (e) {
            console.error("Error al cargar resultados del análisis:", e);
          }
        }
        
        // For files, we can only restore metadata as File objects can't be serialized
        const parsedFiles = JSON.parse(storedFiles);
        if (Array.isArray(parsedFiles) && parsedFiles.length > 0) {
          app.files = parsedFiles.map(f => ({
            id: f.id,
            file: {
              name: f.name,
              size: f.size,
              type: f.type
            },
            textColumn: f.textColumn,
            parsedData: f.parsedData
          }));
          console.log(`${app.files.length} archivos cargados de localStorage`);
        }
        
        return true;
      } catch (e) {
        console.error("Error cargando desde localStorage:", e);
        return false;
      }
    }

    function isLikelySpanish(text) {
      // Simple regex check for Spanish accented characters or common words
      const spanishChars = /[áéíóúüñÁÉÍÓÚÜÑ]/;
      const spanishWords = /(el|la|los|las|de|en|por|que|con|para|como|pero|si|no|cuando|porque|donde|este|esta|estos|estas|ese|esa)/i;
      
      return spanishChars.test(text) || spanishWords.test(text);
    }

    function showErrorBanner(message) {
      // Remove any existing error banner
      const existingBanner = document.getElementById('error-banner');
      if (existingBanner) {
        existingBanner.remove();
      }
      
      // Create error banner
      const banner = document.createElement('div');
      banner.id = 'error-banner';
      banner.className = 'bg-red-600 text-white p-4 rounded-md shadow-md flex justify-between items-center mb-6';
      banner.innerHTML = `
        <div class="flex items-center">
          <i class="fas fa-exclamation-circle mr-2"></i>
          <p>${message}</p>
        </div>
        <button id="close-error-banner" class="text-white hover:text-gray-200">
          <i class="fas fa-times"></i>
        </button>
      `;
      
      // Insert at the beginning of the results section
      elements.resultsSection.insertBefore(banner, elements.resultsSection.firstChild);
      
      // Add close button handler
      document.getElementById('close-error-banner').addEventListener('click', () => {
        banner.remove();
      });
    }

    function checkAnalyzeButtonState() {
      const hasFiles = app.files.length > 0;
      elements.analyzeBtn.disabled = !hasFiles;
    }

    function renderBarChart() {
      if (!app.analysisResults || !app.analysisResults.terms) return;
      
      const ctx = document.getElementById('termsChart');
      
      // Create sample data for the prototype
      const labels = ['diversidad', 'inclusión', 'equidad', 'liderazgo', 'formación', 
                    'oportunidades', 'comunicación', 'representación', 'políticas', 'participación'];
      const frequencyData = [42, 38, 32, 29, 25, 22, 18, 15, 12, 10];
      const percentageData = [35, 31.6, 26.7, 24.2, 20.8, 18.3, 15.0, 12.5, 10.0, 8.3];
      
      // Create chart with two datasets
      const chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Frecuencia',
              data: frequencyData,
              backgroundColor: 'rgba(79, 70, 229, 0.6)',
              borderColor: 'rgba(79, 70, 229, 1)',
              borderWidth: 1,
              order: 2
            },
            {
              label: 'Porcentaje',
              data: percentageData,
              backgroundColor: 'rgba(34, 197, 94, 0.6)',
              borderColor: 'rgba(34, 197, 94, 1)',
              borderWidth: 1,
              type: 'line',
              yAxisID: 'y1',
              order: 1
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Frecuencia'
              },
              position: 'left'
            },
            y1: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Porcentaje (%)'
              },
              position: 'right',
              grid: {
                drawOnChartArea: false
              },
              ticks: {
                callback: function(value) {
                  return value + '%';
                }
              }
            },
            x: {
              title: {
                display: true,
                text: 'Términos'
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const datasetLabel = context.dataset.label || '';
                  const value = context.raw;
                  return datasetLabel === 'Porcentaje' ? 
                    `${datasetLabel}: ${value}%` : 
                    `${datasetLabel}: ${value}`;
                }
              }
            }
          }
        }
      });
      
      app.chartInstances.termsChart = chart;
      
      // Add legend below chart
      const chartContainer = ctx.parentElement;
      if (!chartContainer.querySelector('.chart-legend')) {
        const legend = document.createElement('div');
        legend.className = 'chart-legend';
        
        const freqLegend = document.createElement('div');
        freqLegend.className = 'chart-legend-item';
        freqLegend.innerHTML = '<div class="chart-legend-color" style="background: rgba(79, 70, 229, 0.6)"></div>Frecuencia';
        
        const pctLegend = document.createElement('div');
        pctLegend.className = 'chart-legend-item';
        pctLegend.innerHTML = '<div class="chart-legend-color" style="background: rgba(34, 197, 94, 0.6)"></div>Porcentaje';
        
        legend.appendChild(freqLegend);
        legend.appendChild(pctLegend);
        chartContainer.appendChild(legend);
      }
    }

    function renderWordCloud() {
      const container = document.getElementById('wordCloud');
      if (!container) return;
      
      // Clear previous word cloud
      container.innerHTML = '';
      
      // Create sample word cloud data for the prototype
      const words = [
        {text: 'diversidad', size: 80, value: 42},
        {text: 'inclusión', size: 75, value: 38},
        {text: 'equidad', size: 65, value: 32},
        {text: 'liderazgo', size: 60, value: 29},
        {text: 'formación', size: 55, value: 25},
        {text: 'oportunidades', size: 52, value: 22},
        {text: 'comunicación', size: 45, value: 18},
        {text: 'representación', size: 40, value: 15},
        {text: 'políticas', size: 35, value: 12},
        {text: 'participación', size: 32, value: 10},
        {text: 'transparencia', size: 30, value: 9},
        {text: 'respeto', size: 28, value: 8},
        {text: 'capacitación', size: 26, value: 7},
        {text: 'mejora', size: 25, value: 6},
        {text: 'desarrollo', size: 24, value: 6},
        {text: 'promoción', size: 23, value: 5}
      ];
      
      // Set up tooltip
      const tooltip = document.getElementById('wordcloudTooltip');
      
      // Get container dimensions
      const width = container.offsetWidth;
      const height = container.offsetHeight || 400;
      
      // Create layout
      d3.layout.cloud()
        .size([width, height])
        .words(words)
        .padding(5)
        .rotate(() => ~~(Math.random() * 2) * 90)
        .fontSize(d => d.size)
        .on("end", draw)
        .start();
      
      function draw(words) {
        // Create SVG
        const svg = d3.select('#wordCloud').append("svg")
          .attr("width", width)
          .attr("height", height)
          .append("g")
          .attr("transform", `translate(${width/2},${height/2})`);
        
        // Add words
        svg.selectAll("text")
          .data(words)
          .enter().append("text")
          .style("font-size", d => `${d.size/3}px`)
          .style("fill", (d, i) => d3.schemeCategory10[i % 10])
          .attr("text-anchor", "middle")
          .attr("transform", d => `translate(${d.x},${d.y})rotate(${d.rotate})`)
          .text(d => d.text)
          .on("mouseover", function(event, d) {
            // Show tooltip
            tooltip.style.opacity = 1;
            tooltip.innerHTML = `${d.text}: ${d.value} ocurrencias`;
            tooltip.style.left = `${event.pageX + 10}px`;
            tooltip.style.top = `${event.pageY - 10}px`;
            
            // Highlight word
            d3.select(this)
              .style("font-weight", "bold")
              .style("cursor", "pointer");
          })
          .on("mousemove", function(event) {
            tooltip.style.left = `${event.pageX + 10}px`;
            tooltip.style.top = `${event.pageY - 10}px`;
          })
          .on("mouseout", function() {
            tooltip.style.opacity = 0;
            d3.select(this).style("font-weight", "normal");
          });
      }
    }

    function renderCorrelationChart() {
      // Register the Matrix chart plugin if available
      try {
        if (typeof ChartMatrix !== 'undefined') {
          Chart.register(ChartMatrix.MatrixController, ChartMatrix.MatrixElement);
          app.chartConfig.matrixAvailable = true;
        }
      } catch (err) {
        console.error("Error al registrar el plugin de gráfico de matriz:", err);
      }
      
      const ctx = document.getElementById('correlationChart');
      if (!ctx) return;
      
      // Create sample theme correlation data
      const themeNames = ['Diversidad', 'Inclusión', 'Equidad', 'Liderazgo', 'Comunicación', 'Formación', 'Representación'];
      
      // Create correlation data
      const data = [
        [1.0, 0.8, 0.7, 0.6, 0.5, 0.4, 0.7],
        [0.8, 1.0, 0.7, 0.5, 0.4, 0.5, 0.6],
        [0.7, 0.7, 1.0, 0.8, 0.6, 0.5, 0.5],
        [0.6, 0.5, 0.8, 1.0, 0.7, 0.6, 0.4],
        [0.5, 0.4, 0.6, 0.7, 1.0, 0.7, 0.3],
        [0.4, 0.5, 0.5, 0.6, 0.7, 1.0, 0.5],
        [0.7, 0.6, 0.5, 0.4, 0.3, 0.5, 1.0]
      ];
      
      // Create chart based on availability of matrix plugin
      if (app.chartConfig.matrixAvailable) {
        const flatData = [];
        for (let i = 0; i < themeNames.length; i++) {
          for (let j = 0; j < themeNames.length; j++) {
            flatData.push({
              x: i,
              y: j,
              v: data[i][j]
            });
          }
        }
        
        app.chartInstances.correlationChart = new Chart(ctx, {
          type: 'matrix',
          data: {
            datasets: [{
              label: 'Correlación de temas',
              data: flatData,
              backgroundColor(context) {
                const value = context.dataset.data[context.dataIndex].v;
                const alpha = value * 0.8 + 0.2;
                return `rgba(79, 70, 229, ${alpha})`;
              },
              borderColor: '#fff',
              borderWidth: 1,
              width: ({ chart }) => (chart.chartArea || {}).width / themeNames.length - 1,
              height: ({ chart }) => (chart.chartArea || {}).height / themeNames.length - 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              x: {
                type: 'category',
                labels: themeNames,
                ticks: {
                  display: true
                },
                grid: {
                  display: false
                }
              },
              y: {
                type: 'category',
                labels: themeNames,
                offset: true,
                ticks: {
                  display: true
                },
                grid: {
                  display: false
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  title: function(context) {
                    const i = context[0].dataIndex % themeNames.length;
                    const j = Math.floor(context[0].dataIndex / themeNames.length);
                    return `${themeNames[i]} - ${themeNames[j]}`;
                  },
                  label: function(context) {
                    return `Correlación: ${context.raw.v.toFixed(2)}`;
                  }
                }
              }
            }
          }
        });
      } else {
        // Fallback to bar chart
        const flatData = [];
        for (let i = 0; i < themeNames.length; i++) {
          for (let j = i+1; j < themeNames.length; j++) {
            flatData.push({
              pair: `${themeNames[i]} - ${themeNames[j]}`,
              value: data[i][j]
            });
          }
        }
        
        // Sort by correlation value
        flatData.sort((a, b) => b.value - a.value);
        
        // Take top 10 correlations
        const topCorrelations = flatData.slice(0, 10);
        
        app.chartInstances.correlationChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: topCorrelations.map(item => item.pair),
            datasets: [{
              label: 'Correlación',
              data: topCorrelations.map(item => item.value),
              backgroundColor: 'rgba(79, 70, 229, 0.6)',
              borderColor: 'rgba(79, 70, 229, 1)',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: 'y',
            scales: {
              x: {
                beginAtZero: true,
                max: 1,
                title: {
                  display: true,
                  text: 'Correlación'
                }
              },
              y: {
                title: {
                  display: true,
                  text: 'Pares de temas'
                }
              }
            },
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return `Correlación: ${context.raw.toFixed(2)}`;
                  }
                }
              }
            }
          }
        });
      }
    }

    function renderCharts() {
      renderBarChart();
      renderWordCloud();
      renderCorrelationChart();
    }

    function updateFileList() {
      if (!elements.fileItemsContainer) return;
      
      // Clear file list
      elements.fileItemsContainer.innerHTML = '';
      
      // Update file list UI
      if (app.files.length > 0) {
        elements.fileList.classList.remove('hidden');
        
        app.files.forEach(fileEntry => {
          const fileItem = document.createElement('div');
          fileItem.className = 'file-item flex items-center justify-between p-3 rounded-md';
          fileItem.dataset.id = fileEntry.id;
          
          // Get file extension
          const ext = fileEntry.file.name.split('.').pop().toLowerCase();
          
          // Set icon based on file type
          let fileIcon = 'fa-file';
          if (ext === 'csv') fileIcon = 'fa-file-csv';
          else if (ext === 'xlsx' || ext === 'xls') fileIcon = 'fa-file-excel';
          else if (ext === 'txt') fileIcon = 'fa-file-alt';
          
          // Get status indicator
          const status = fileEntry.parsedData ? 
            (fileEntry.textColumn !== null || ext === 'txt' ? 
              '<span class="text-green-600"><i class="fas fa-check-circle"></i> Listo</span>' : 
              '<span class="text-yellow-500"><i class="fas fa-exclamation-circle"></i> Seleccionar columna</span>') :
            '<span class="text-gray-400"><i class="fas fa-clock"></i> Pendiente</span>';
          
          fileItem.innerHTML = `
            <div class="flex items-center">
              <i class="fas ${fileIcon} text-indigo-500 text-xl mr-3"></i>
              <div>
                <p class="text-sm font-medium text-gray-700">${fileEntry.file.name}</p>
                <p class="text-xs text-gray-500">${formatFileSize(fileEntry.file.size)}</p>
              </div>
            </div>
            <div class="flex items-center">
              ${status}
              <button class="ml-4 text-gray-500 hover:text-red-600 delete-file" data-id="${fileEntry.id}">
                <i class="fas fa-trash-alt"></i>
              </button>
            </div>
          `;
          
          elements.fileItemsContainer.appendChild(fileItem);
          
          // Add event listener for delete button
          const deleteBtn = fileItem.querySelector('.delete-file');
          if (deleteBtn) {
            deleteBtn.addEventListener('click', (e) => {
              e.stopPropagation();
              const fileId = deleteBtn.dataset.id;
              app.files = app.files.filter(f => f.id !== fileId);
              saveToLocalStorage();
              updateFileList();
              checkAnalyzeButtonState();
            });
          }
          
          // Add click handler for selecting column if CSV/Excel file
          if (ext === 'csv' || ext === 'xlsx' || ext === 'xls') {
            fileItem.addEventListener('click', () => {
              document.querySelectorAll('.file-item').forEach(item => item.classList.remove('selected'));
              fileItem.classList.add('selected');
              showColumnSelector(fileEntry);
            });
          }
        });
      } else {
        elements.fileList.classList.add('hidden');
      }
    }

    function updateUI() {
      // Refresh file list and button states
      updateFileList();
      checkAnalyzeButtonState();

      // Show results or upload section
      if (app.analysisResults) {
        elements.uploadSection.classList.add('hidden');
        elements.resultsSection.classList.remove('hidden');
        renderCharts();
      } else {
        elements.uploadSection.classList.remove('hidden');
        elements.resultsSection.classList.add('hidden');
      }
    }

    function switchTab(tabName) {
      // Remove active class from all tabs
      elements.tabButtons.forEach(btn => btn.classList.remove('active'));
      elements.tabContents.forEach(tab => tab.classList.remove('active'));
      
      // Add active class to selected tab
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(tabName).classList.add('active');
    }

    function resetApp() {
      app.files = [];
      app.analysisResults = null;
      app.chartInstances = {};
      app.unsavedChanges = false;
      localStorage.removeItem('qualitext_files');
      localStorage.removeItem('qualitext_results');
      localStorage.removeItem('qualitext_timestamp');
      updateUI();
    }

    function exportResults() {
      // Create ZIP file with sample results for prototype
      const zip = new JSZip();
      
      // Add sample JSON export
      const sampleResults = {
        terms: [
          { term: "diversidad", frequency: 42, percentage: 35 },
          { term: "inclusión", frequency: 38, percentage: 31.6 },
          { term: "equidad", frequency: 32, percentage: 26.7 }
        ],
        themes: [
          { name: "Diversidad e inclusión", description: "Comentarios sobre políticas de inclusión" },
          { name: "Equidad y liderazgo", description: "Percepciones sobre oportunidades de liderazgo" }
        ]
      };
      
      zip.file("analisis_resultados.json", JSON.stringify(sampleResults, null, 2));
      
      // Add sample CSV exports
      const termsCsv = [
        "Término,Frecuencia,Porcentaje,Relevancia",
        "diversidad,42,35,85",
        "inclusión,38,31.6,82",
        "equidad,32,26.7,79"
      ].join("\n");
      
      zip.file("terminos.csv", termsCsv);
      
      // Generate and download the zip
      zip.generateAsync({type: "blob"}).then(function(content) {
        saveAs(content, "analisis_cualitativo_resultados.zip");
      });
    }

    function exportExcel() {
      // Create workbook with sample data for prototype
      const wb = XLSX.utils.book_new();
      
      // Add terms worksheet
      const termsData = [
        { Término: "diversidad", Frecuencia: 42, Porcentaje: 35, Relevancia: 85 },
        { Término: "inclusión", Frecuencia: 38, Porcentaje: 31.6, Relevancia: 82 },
        { Término: "equidad", Frecuencia: 32, Porcentaje: 26.7, Relevancia: 79 }
      ];
      
      const termsWs = XLSX.utils.json_to_sheet(termsData);
      XLSX.utils.book_append_sheet(wb, termsWs, "Términos Clave");
      
      // Add themes worksheet
      const themesData = [
        { Tema: "Diversidad e inclusión", Descripción: "Comentarios sobre políticas de inclusión", Porcentaje: 42 },
        { Tema: "Equidad y liderazgo", Descripción: "Percepciones sobre oportunidades de liderazgo", Porcentaje: 38 }
      ];
      
      const themesWs = XLSX.utils.json_to_sheet(themesData);
      XLSX.utils.book_append_sheet(wb, themesWs, "Temas");
      
      // Write and save the file
      XLSX.writeFile(wb, "analisis_cualitativo.xlsx");
    }

    async function handleFiles(files) {
      if (!files || files.length === 0) return;
      
      // Process each file
      for (const file of files) {
        // Check if file already exists in the list
        if (app.files.some(f => f.file.name === file.name)) {
          showToast(`El archivo ${file.name} ya ha sido agregado.`, 'warning');
          continue;
        }
        
        const fileEntry = { 
          file, 
          id: Date.now() + Math.random().toString(36).substr(2, 9),
          textColumn: null,
          parsedData: null
        };
        
        // Get file extension
        const ext = file.name.split('.').pop().toLowerCase();
        
        // Handle different file types
        if (ext === 'txt') {
          // For TXT files, read as text and split by lines
          const text = await file.text();
          fileEntry.parsedData = text.split(/\r?\n/).filter(line => line.trim() !== '');
          fileEntry.textColumn = null; // Not needed for TXT
        } else if (ext === 'csv') {
          // For CSV, use PapaParse to parse
          // In prototype, we'll just store the file and show the column selector
          fileEntry.parsedData = [
            { "ID": "1", "Nombre": "Juan", "Respuesta": "La diversidad es importante" },
            { "ID": "2", "Nombre": "Maria", "Respuesta": "Necesitamos más inclusión" }
          ];
          // Column selection will happen when user clicks on file
        } else if (ext === 'xlsx' || ext === 'xls') {
          // For Excel, we'd normally use xlsx.js to parse
          // In prototype, we'll just store the file and show the column selector
          fileEntry.parsedData = [
            { "ID": "1", "Nombre": "Juan", "Respuesta": "La diversidad es importante" },
            { "ID": "2", "Nombre": "Maria", "Respuesta": "Necesitamos más inclusión" }
          ];
          // Column selection will happen when user clicks on file
        } else {
          showToast(`El formato de archivo ${ext} no es soportado.`, 'error');
          continue;
        }
        
        // Add file to list
        app.files.push(fileEntry);
      }
      
      // Update UI
      saveToLocalStorage();
      updateUI();
    }

    function analyzeData() {
      showLoading('Analizando textos...');
      
      // Simulate analysis process with delayed steps
      setTimeout(() => {
        elements.loadingMessage.textContent = 'Procesando datos...';
        
        setTimeout(() => {
          elements.loadingMessage.textContent = 'Identificando términos clave...';
          
          setTimeout(() => {
            elements.loadingMessage.textContent = 'Extrayendo patrones y temas...';
            
            setTimeout(() => {
              elements.loadingMessage.textContent = 'Generando visualizaciones...';
              
              setTimeout(() => {
                // Create sample analysis results
                app.analysisResults = {
                  totalTerms: 68,
                  totalResponses: 120,
                  avgRelevance: 78,
                  terms: [
                    { term: "diversidad", frequency: 42, percentage: "35", relevance: 85, 
                      examples: ["La diversidad en el equipo ha mejorado notablemente este año", "Necesitamos más diversidad en puestos de liderazgo"] },
                    { term: "inclusión", frequency: 38, percentage: "31.6", relevance: 82, 
                      examples: ["Las políticas de inclusión han sido bien recibidas", "Falta una verdadera cultura de inclusión"] },
                    // More terms would be added here in a real implementation
                  ],
                  wordCloud: [
                    {text: 'diversidad', size: 42, value: 42},
                    {text: 'inclusión', size: 38, value: 38},
                    // More words would be added here
                  ],
                  themes: [
                    {name: "Diversidad e inclusión", description: "Comentarios sobre políticas de inclusión y representación diversa", 
                     percentage: 42, relatedTerms: ["diversidad", "inclusión", "representación"]},
                    {name: "Equidad y liderazgo", description: "Percepciones sobre equidad y oportunidades de liderazgo", 
                     percentage: 38, relatedTerms: ["equidad", "liderazgo", "oportunidades"]},
                    // More themes would be added here
                  ],
                  patterns: [
                    {pattern: "Necesidad de mayor formación", frequency: 18, 
                     examples: ["Hace falta más capacitación sobre diversidad e inclusión", "Se requieren talleres prácticos sobre equidad", "La formación actual es insuficiente"]},
                    {pattern: "Problemas de comunicación", frequency: 12, 
                     examples: ["La comunicación entre departamentos es deficiente", "No hay transparencia en las decisiones", "Falta de claridad en los objetivos"]},
                    // More patterns would be added here
                  ],
                  analysis: {
                    summary: "El análisis de las respuestas muestra una preocupación generalizada por la diversidad e inclusión en el entorno laboral. Los participantes reconocen avances significativos en políticas institucionales, pero señalan brechas importantes en su implementación práctica y en la representación en posiciones de liderazgo. La formación y comunicación emergen como áreas críticas de mejora.",
                    findings: [
                      "Las respuestas muestran una tendencia positiva en la percepción de las políticas de diversidad, con un 68% de menciones favorables.",
                      "Existe una brecha significativa entre el reconocimiento de políticas (82%) y su implementación efectiva (43%).",
                      "Los comentarios sobre formación y capacitación representan el tercer tema más mencionado, sugiriendo una necesidad no cubierta."
                    ],
                    detailedText: "El análisis de las respuestas cualitativas revela patrones consistentes sobre la percepción de diversidad e inclusión en la organización. Los términos más frecuentes (\"diversidad\", \"inclusión\", \"equidad\") aparecen en contextos tanto positivos como críticos, lo que indica una valoración matizada de las iniciativas organizacionales.\n\nLas referencias a \"liderazgo\" suelen estar vinculadas a preocupaciones sobre representación diversa en puestos directivos, mientras que las menciones de \"comunicación\" tienden a enfocarse en la transparencia de políticas y decisiones.\n\nEl análisis de co-ocurrencia muestra una fuerte asociación entre \"capacitación\" y \"necesidad\", sugiriendo que las iniciativas formativas actuales no satisfacen completamente las expectativas del personal.\n\nLa intensidad emocional es más alta en comentarios relacionados con \"oportunidades\" y \"promoción\", indicando que las percepciones de equidad en el desarrollo profesional generan respuestas particularmente enfáticas.",
                    recommendations: [
                      "Reforzar programas de capacitación específica sobre diversidad e inclusión, con énfasis en aplicaciones prácticas.",
                      "Implementar medidas concretas para aumentar la transparencia en procesos de promoción y desarrollo profesional.",
                      "Establecer canales de comunicación bidireccionales para monitorear la efectividad de las políticas implementadas.",
                      "Desarrollar indicadores específicos para medir el progreso en diversidad e inclusión a nivel departamental."
                    ]
                  }
                };
                
                hideLoading();
                saveToLocalStorage();
                updateUI();
              }, 800);
            }, 700);
          }, 600);
        }, 500);
      }, 400);
    }

    // Help modal handlers
    elements.helpBtn.addEventListener('click', () => {
      elements.helpModal.classList.remove('hidden');
    });

    elements.closeHelpBtn.addEventListener('click', () => {
      elements.helpModal.classList.add('hidden');
    });

    // File input change handler
    elements.fileInput.addEventListener('change', (e) => {
      handleFiles(e.target.files);
    });

    // Drag and drop handlers
    elements.dragArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      elements.dragArea.classList.add('active');
    });

    elements.dragArea.addEventListener('dragleave', () => {
      elements.dragArea.classList.remove('active');
    });

    elements.dragArea.addEventListener('dragenter', (e) => {
      e.preventDefault();
      elements.dragArea.classList.add('active');
    });

    elements.dragArea.addEventListener('drop', (e) => {
      e.preventDefault();
      elements.dragArea.classList.remove('active');
      handleFiles(e.dataTransfer.files);
    });

    // Tab switching
    elements.tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const tabName = btn.getAttribute('data-tab');
        switchTab(tabName);
      });
    });

    // Chart controls
    elements.topTermsCount.addEventListener('change', renderBarChart);
    elements.freqThreshold.addEventListener('change', () => {
      renderBarChart();
      renderWordCloud();
    });

    // Action buttons
    elements.analyzeBtn.addEventListener('click', analyzeData);
    elements.resetBtn.addEventListener('click', resetApp);
    elements.exportBtn.addEventListener('click', exportResults);
    elements.exportExcelBtn.addEventListener('click', exportExcel);

    // Initialize the app
    document.addEventListener('DOMContentLoaded', async () => {
      // Try to load from local storage
      await loadFromLocalStorage();
      
      // Update UI based on loaded state
      updateUI();
    });

    // Prevent browser defaults for drag and drop
    document.addEventListener('dragover', e => e.preventDefault());
    document.addEventListener('drop', e => e.preventDefault());

    // Initialize the app
    updateUI();
  </script>
</body>
</html>